{% extends 'index.html' %}
{% block content %}
{% load static %}
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  body {
    font-family: 'Poppins', sans-serif;
  }
  .hero-wrap {
    background-size: cover;
    background-position: center;
    position: relative;
  }
  .hero-wrap .overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
  }
  .hero-wrap .container {
    position: relative;
    z-index: 1;
  }
  .hero-wrap h1 {
    color: white;
    font-size: 2.5rem;
    margin-bottom: 0;
  }
  .hero-wrap .breadcrumbs {
    color: white;
    font-size: 1rem;
  }
  .hero-wrap .breadcrumbs a {
    color: white;
    text-decoration: none;
  }
  .hero-wrap .breadcrumbs a:hover {
    text-decoration: underline;
  }
  .cart-list table {
    width: 100%;
    margin-bottom: 2rem;
  }
  .cart-list thead {
    background-color: #f8f9fa;
  }
  .cart-list thead th {
    text-transform: uppercase;
    font-weight: bold;
    padding: 1rem;
  }
  .cart-list tbody td {
    padding: 1rem;
    vertical-align: middle;
  }
  .cart-list .product-remove {
    text-align: center;
  }
  .cart-list .image-prod {
    width: 80px;
    height: 80px;
    margin: auto;
  }
  .cart-list .image-prod .img {
    width: 100px;
    height: 100px;
    background-size: cover;
    background-position: center;
  }
  .cart-list .product-name h3 {
    margin: 0;
    font-size: 1rem;
  }
  .cart-list .product-name p {
    margin: 0.5rem 0;
    font-size: 0.875rem;
    color: #6c757d;
  }
  .cart-list .price, .cart-list .total {
    text-align: right;
  }
  .cart-total {
    background-color: #f8f9fa;
    padding: 2rem;
    border-radius: 0.25rem;
  }
  .cart-total h3 {
    margin-bottom: 1rem;
  }
  .cart-total p {
    margin: 0.5rem 0;
    display: flex;
    justify-content: space-between;
  }
  .cart-total .total-price {
    font-weight: bold;
  }
  .btn-primary {
    background-color: #007bff;
    border-color: #007bff;
  }
  .btn-primary:hover {
    background-color: #0056b3;
    border-color: #0056b3;
  }
  .btn-danger {
    background-color: #dc3545;
    border-color: #dc3545;
    color: white;
  }
  .btn-danger:hover {
    background-color: #bd2130;
    border-color: #bd2130;
  }
  .modal-backdrop {
    background-color: transparent !important;
  }
  .cart-card{
    border: none;
    min-height: 800px;
    background:  #ffffff !important;
    padding:0px !important;
  }

  .cart-summary-card{
    border: none;
    background:  #ffffff !important;
    box-shadow: none !important;
  }

  .empty-cart {
    text-align: center;
    padding: 50px 0;
  }
  .empty-cart-icon {
    font-size: 5rem;
    color: #6c757d;
    margin-bottom: 20px;
  }
  .empty-cart-btn {
    margin-top: 20px;
  }

  /* Responsive Styles */
  @media (max-width: 768px) {
    .hero-wrap h1 {
      font-size: 2rem;
    }
    .cart-list thead th, .cart-list tbody td {
      padding: 0.5rem;
    }
    .cart-list .image-prod {
      width: 60px;
      height: 60px;
    }
    .cart-list .image-prod .img {
      width: 60px;
      height: 60px;
    }
    .cart-total {
      padding: 1rem;
    }
  }

  @media (max-width: 576px) {
    .hero-wrap h1 {
      font-size: 1.5rem;
    }
    .cart-list thead th, .cart-list tbody td {
      padding: 0.3rem;
    }
    .cart-list .image-prod {
      width: 40px;
      height: 40px;
    }
    .cart-list .image-prod .img {
      width: 40px;
      height: 40px;
    }
    .cart-total {
      padding: 0.5rem;
    }
  }
  @media (max-width: 768px) {
  .cart-list table {
    width: 100%;
    margin-bottom: 2rem;
  }
  .cart-list thead th, .cart-list tbody td {
    padding: 0.5rem;
  }
  .cart-list .image-prod {
    width: 60px;
    height: 60px;
  }
  .cart-list .image-prod .img {
    width: 60px;
    height: 60px;
  }
}

@media (max-width: 576px) {
  .cart-list thead th, .cart-list tbody td {
    padding: 0.3rem;
  }
  .cart-list .image-prod {
    width: 40px;
    height: 40px;
  }
  .cart-list .image-prod .img {
    width: 40px;
    height: 40px;
  }
}
</style>

<section class="hero-wrap hero-wrap-2" style="background-image:url({% static 'images/bg_1.jpg' %});" data-stellar-background-ratio="0.5">
  <div class="overlay"></div>
  <div class="container">
    <div class="row no-gutters slider-text align-items-end">
      <div class="col-md-9 ftco-animate pb-5">
        <p class="breadcrumbs mb-2"><span class="mr-2"><a href="{% url 'home' %}">Home <i class="fa fa-chevron-right"></i></a></span> <span>Cart <i class="fa fa-chevron-right"></i></span></p>
        <h1 class="mb-0 bread" style="color:grey!important;">Cart</h1>
      </div>
    </div>
  </div>
</section>

<section class="ftco-section ftco-cart" style="padding:  0 !important; margin-bottom:00px;">
  <div class="container"  style="margin-block: 40px !important;">
    <div class="row justify-content-center">
      <div class="col-md-7 heading-section text-center ftco-animate">
        <span class="subheading">Your Cart Awaits</span>
        <h2>Complete Your Journey</h2>
      </div>
    </div>
  </div>
  <div class="container-fluid mb-5">
    <div class="cart-card card ">
      {% if cart_items %}
      <div class="row">
        <div class="col-12">
          <div class="cart-list">
          <div class="table-responsive">
            <table class="table">
              <thead class="thead-primary">
                <tr>
                  <th>Sl No.</th>
                  <th>&nbsp;</th>
                  <th>Product</th>
                  <th>Price</th>
                  <th>Quantity</th>
                  <th>&nbsp;</th>
                  <th>Total</th>
                </tr>
              </thead>
              <tbody>
                {% for item in cart_items %}
                <tr>
                  <td class="product-remove">
                    {{forloop.counter}}
                  </td>
                  <td class="image-prod">
                    <div class="img" style="background-image:url({{ item.product.image }});"></div>
                  </td>
                  <td class="product-name">
                    <h3>{{ item.product.name }}</h3>
                    <p>{{ item.product.description|slice:":50" }}</p>
                  </td>
                  <td class="price">INR {{ item.price }}</td>
                  <td class="quantity">
                    <div class="input-group m-2">
                      <input type="number" id="item-count-{{ item.product.sku }}" class="form-control small-width" min="1" value="{{ item.quantity }}">
                    </div>
                  </td>
                  <td class="product-remove">
                    <button class="btn btn-danger btn-sm" onclick="deleteItem('{{ item.product.sku }}')">
                      <i class="fa fa-trash"></i>
                    </button>
                  </td>
                  <td class="total">INR {{ item.total_price }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          </div>
        </div>
      </div>
      <hr>
      <div class="row justify-content-end ">
        <div class="col col-lg-5 col-md-6  cart-wrap ftco-animate">
            <div class="cart-summary-card card mb-4 ">
                <div class="card-body">
                    <h6 class="card-title">Cart Summary</h6>
                    <div class="d-flex justify-content-between">
                        <p class="mb-0">Subtotal</p>
                        <p class="mb-0" id="cart-subtotal">INR {{ cart_subtotal }}</p>
                    </div>
                    <div class="d-flex justify-content-between">
                        <p class="mb-0">Delivery</p>
                        <p class="mb-0" id="cart-delivery">Free</p>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between">
                        <p class="mb-0 total-price">Total</p>
                        <p class="mb-0" id="cart-total">INR {{ cart_total }}</p>
                    </div>
                    <div class="d-flex justify-content-between">
                        <p class="mb-0">Items</p>
                        <p class="mb-0" id="cart-count">{{ cart_count }}</p>
                    </div>
                    <a href="{% url 'checkout' %}" class="btn btn-primary btn-block mt-3">Proceed to Checkout</a>
                </div>
            </div>
        </div>
      </div>
      {% else %}
      <div class="row mt-5 pt-5">
        <div class="col-12">
          <div class="empty-cart">
            <div class="empty-cart-icon">
              <i class="fa fa-shopping-cart"></i>
            </div>
            <h3>Your cart is empty</h3>
            <p>Looks like you haven't added any products to your cart yet.</p>
            <a href="{% url 'home' %}" class="btn btn-primary empty-cart-btn">
              <i class="fa fa-arrow-left"></i> Continue Shopping
            </a>
          </div>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</section>

<!-- Confirmation Modal -->
<div class="modal fade" id="deleteConfirmationModal" tabindex="-1" role="dialog" aria-labelledby="deleteConfirmationModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteConfirmationModalLabel">Confirm Deletion</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        Are you sure you want to delete this item from your cart?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
      </div>
    </div>
  </div>
</div>

<script>
  // Function to get CSRF token from cookie
  function getCSRFToken() {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
              const cookie = cookies[i].trim();
              if (cookie.substring(0, 'csrftoken'.length + 1) === ('csrftoken' + '=')) {
                  cookieValue = decodeURIComponent(cookie.substring('csrftoken'.length + 1));
                  break;
              }
          }
      }
      return cookieValue;
  }

  // Function to delete an item from the cart
  function deleteItem(productSku) {
      // Initialize Bootstrap modal
      const modal = new bootstrap.Modal(document.getElementById('deleteConfirmationModal'));
      // Show confirmation modal
      modal.show();
      
      // Store the product SKU temporarily
      document.getElementById('confirmDeleteBtn').setAttribute('data-product-sku', productSku);
  }

  // Handle confirmation button click
  document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
          const productSku = this.getAttribute('data-product-sku');
          
          // Hide the modal immediately
          const modalElement = document.getElementById('deleteConfirmationModal');
          modalElement.classList.remove('show');
          document.body.classList.remove('modal-open');
          const modalBackdrops = document.querySelectorAll('.modal-backdrop');
          modalBackdrops.forEach(backdrop => {
              backdrop.remove();
          });
          
          // Send delete request to the server
          fetch('/update-cart/', {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json',
                  'X-CSRFToken': getCSRFToken() // Include CSRF token for Django
              },
              body: JSON.stringify({
                  product_sku: productSku,
                  action: "delete"
              })
          })
          .then(response => response.json())
          .then(data => {
              if (data.success) {
                  let cartCount = data.cart_count;
                  document.getElementById('cart-badge').textContent = cartCount;
                  
                  // If this was the last item, reload the page to show empty cart
                  if (cartCount === 0) {
                      window.location.reload();
                      return;
                  }
                  
                  // Remove the item row from the DOM
                  const row = document.querySelector(`#item-count-${productSku}`).closest('tr');
                  row.remove();
                  
                  // Update cart summary
                  document.getElementById('cart-subtotal').textContent = `INR ${data.cart_subtotal}`;
                  document.getElementById('cart-total').textContent = `INR ${data.cart_total}`;
                  document.getElementById('cart-count').textContent = data.cart_count;
              } else {
                  console.error('Error deleting item from cart:', data.error);
              }
          })
          .catch(error => {
              console.error('Error deleting item from cart:', error);
          });
      });

      // Function to update quantity and recalculate totals
      function updateQuantity(input, productSku) {
          let quantity = parseInt(input.value, 10);
          if (isNaN(quantity) || quantity <= 0) {
              quantity = 1; // Default to 1 if invalid
              input.value = 1;
          }

          // Send updated quantity to the server
          fetch('/update-cart/', {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json',
                  'X-CSRFToken': getCSRFToken() // Include CSRF token for Django
              },
              body: JSON.stringify({
                  product_sku: productSku,
                  action: "update_qty",
                  quantity: quantity
              })
          })
          .then(response => response.json())
          .then(data => {
              if (data.success) {
                  let cartCount = data.cart_count;
                  document.getElementById('cart-badge').textContent = cartCount;
                  // Find the updated item in the cart_items list
                  const updatedItem = data.cart_items.find(item => item.product.sku === productSku);
                  
                  if (updatedItem) {
                      // Update quantity input
                      document.getElementById(`item-count-${productSku}`).value = updatedItem.quantity;
                      

                      // Update total price for the item
                      const row = document.querySelector(`#item-count-${productSku}`).closest('tr');
                      row.querySelector('.total').textContent = `INR ${updatedItem.total_price}`;
                  }
                  
                  // Update cart summary
                  document.getElementById('cart-subtotal').textContent = `INR ${data.cart_subtotal}`;
                  document.getElementById('cart-total').textContent = `INR ${data.cart_total}`;
                  document.getElementById('cart-count').textContent = data.cart_count;
              } else {
                  console.error('Error updating cart:', data.error);
              }
          })
          .catch(error => {
              console.error('Error updating cart:', error);
          });
      }

      // Add event listeners to quantity inputs
      document.querySelectorAll('[id^="item-count-"]').forEach(function(input) {
          input.addEventListener('input', function() {
              const productSku = this.id.split('-')[2];
              if (productSku) {
                  updateQuantity(this, productSku);
              } else {
                  console.error('Product SKU not found in input ID');
              }
          });
      });
  });
</script>

{% endblock %}